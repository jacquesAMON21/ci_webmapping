<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Projet Leaflet Jacques AMON</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="" crossorigin="" />
  <!-- Leaflet Routing Machine CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <!-- Leaflet Search CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-search@2.9.9/dist/leaflet-search.min.css" />

  <style>
    /* Reset & layout */
    html,body{height:100%;margin:0;font-family:Arial, Helvetica, sans-serif}
    #app{display:flex;flex-direction:column;height:100vh}

    /* Header with controls */
    header{display:flex;gap:8px;align-items:center;padding:8px;background:#fafafa;border-bottom:1px solid #eee}
    header .title{font-weight:700}
    header .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
    button{padding:6px 10px;border-radius:6px;border:1px solid #ddd;background:white;cursor:pointer}
    button:active{transform:translateY(1px)}

    /* Map area */
    #map{flex:1;min-height:300px}

    /* Legend box */
    .legend{background:white;padding:8px;border-radius:6px;box-shadow:0 1px 6px rgba(0,0,0,0.15);font-size:14px}
    .legend h4{margin:0 0 6px 0;font-size:13px}
    .legend .item{display:flex;align-items:center;gap:8px;margin:4px 0}
    .legend .swatch{width:18px;height:12px;border-radius:2px}

    /* Responsive: controls collapse on small screens */
    @media (max-width:720px){
      header{padding:6px;font-size:14px}
      .legend{font-size:13px}
      button{padding:6px}
    }

    /* Small helper for popups */
    .popup-route{display:inline-block;margin-top:6px;padding:4px 6px;border-radius:4px;background:#f5f5f5;color:white;text-decoration:none}
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="title">République de Côte d'Ivoire</div>
      <div class="controls">
        <button id="btn-locate">Ma position</button>
        <button id="btn-clear-route">Supprimer itinéraire</button>
        <!-- Search control will be added by plugin into the map -->
      </div>
    </header>

    <div id="map"></div>
  </div>

  <!-- JS libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
  <script src="https://unpkg.com/leaflet-search@2.9.9/dist/leaflet-search.src.js"></script>

  <script>
  // ================ Configuration ================
  // Remplacez ces chemins par l'URL ou le chemin correct vers vos fichiers GeoJSON
  const POINTS_GEOJSON = 'data/points_ci.geojson'   // ex: villages (avec propriété "name")
  const REGIONS_GEOJSON = 'data/regions_ci.geojson' // ex: régions/districts (avec propriété "name")

  // Style functions
  function styleRegions(feature){
    return {
      weight: 1,
      color: '#3498db',
      fillColor: '#3498db',
      fillOpacity: 0.3
    }
  }
  function styleRegionsHighlight(){
    return {weight:2,color:'#c0392b',fillOpacity:0.7}
  }

  function pointToMarker(feature,latlng){
    const marker = L.circleMarker(latlng,{radius:6,fillColor:'#d35400',color:'#d35400',weight:1,fillOpacity:0.6});
    return marker;
  }

  

  // Popup points
  function makePopupContent(props){
    // Exemple: props.name, props.type, props.population
    let html = `<strong>${props.name || '—'}</strong><br/>`;
    if(props.place) html += `Type: ${props.place}<br/>`;
    if(props.osm_id) html += `ID OSM: ${props.osm_id}<br/>`;
    if(props.Nom_2) html += `Région: ${props.Nom_2}<br/>`;
    if(props.Nom_3) html += `Département: ${props.Nom_3}<br/>`;
    if(props.Nom_4) html += `Sous-préfecture: ${props.Nom_4}<br/>`;
    if(props.Adminitraion) html += `Type: ${props.Adminitraion}<br/>`;
    html += `<a class="popup-route" href="#" data-action="route">Itinéraire</a>`;
    return html;
  }

  // ================ Init map ================
  const map = L.map('map',{
    center: [7.54, -5.55], // centre approximatif Côte d'Ivoire
    zoom: 7,
    minZoom: 4,
    maxZoom: 18
  });

  // Basemaps
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap contributors'});
  const Google_Satellite = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{attribution:'© Google Satellite Hybrid'});
  const Topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{attribution:'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'});
  osm.addTo(map);

  // Layer groups to hold GeoJSON
  const pointsLayer = L.featureGroup();
  const regionsLayer = L.featureGroup();

  // Layer control (basemaps + overlays)
  const baseMaps = { 'OSM': osm, 'Google Satellite Hybrid': Google_Satellite, 'OpenTopoMap': Topo };
  const overlays = { 'Localité': pointsLayer, 'Découpage Adminitrative': regionsLayer };
  L.control.layers(baseMaps, overlays, {collapsed:false}).addTo(map);

  // Zoom control - Leaflet has it by default but we can move it
  map.zoomControl.setPosition('topright');

  // Legend control (custom)
  const legend = L.control({position:'bottomleft'});
  legend.onAdd = function(){
    const div = L.DomUtil.create('div','legend');
    div.innerHTML = `<h4>Légende</h4>
      <div class="item"><span class="swatch" style="background:#3498db"></span> Découpage Administrative</div>
      <div class="item"><span class="swatch" style="background:#d35400"></span> Localité </div>`;
    return div;
  }
  legend.addTo(map);

  // Routing control (Leaflet Routing Machine)
  let routingControl = null;
  function clearRoute(){
    if(routingControl){map.removeControl(routingControl);routingControl = null}
  }

  document.getElementById('btn-clear-route').addEventListener('click',()=>{ clearRoute(); });

  // Helper: set route from 'fromLatLng' to 'toLatLng'
  function routeBetween(fromLatLng,toLatLng){
    clearRoute();
    routingControl = L.Routing.control({
      waypoints: [fromLatLng,toLatLng],
      routeWhileDragging: false,
      showAlternatives: false,
      fitSelectedRoute: true,
      router: L.Routing.osrmv1({serviceUrl: 'https://router.project-osrm.org/route/v1'})
    }).addTo(map);
  }

  // Locate me button
  document.getElementById('btn-locate').addEventListener('click', ()=>{
    if(!navigator.geolocation){ alert('Géolocalisation non supportée'); return }
    navigator.geolocation.getCurrentPosition(pos=>{
      const latlng = L.latLng(pos.coords.latitude,pos.coords.longitude);
      L.marker(latlng).addTo(map).bindPopup('Vous êtes ici').openPopup();
      map.setView(latlng,13);
    }, err=>{alert('Impossible de récupérer la position: '+err.message)})
  });

  // ================ Load GeoJSON files and add interactions ================
  // Generic function to fetch and add GeoJSON
  async function loadGeoJSON(url, options={}){
    try{
      const res = await fetch(url);
      if(!res.ok) throw new Error('Erreur chargement '+url+': '+res.status);
      const geojson = await res.json();
      const layer = L.geoJSON(geojson, options);
      return {layer,geojson};
    }catch(e){console.error(e);alert('Erreur chargement: '+e.message)}
  }

  // Load regions
  (async ()=>{
    const r = await loadGeoJSON(REGIONS_GEOJSON,{
      style: styleRegions,
      onEachFeature: function(feature, layer){
        const props = feature.properties || {};
        layer.bindPopup(makePopupContent(props));
        layer.on({
          mouseover: function(){ layer.setStyle(styleRegionsHighlight()); },
          mouseout: function(){ layer.setStyle(styleRegions(feature)); }
        });
      }
    });
    if(r && r.layer){ regionsLayer.addLayer(r.layer); map.addLayer(regionsLayer); }

    // Fit to regions if any
    try{ if(r && r.layer && r.layer.getBounds && !map._loaded) map.fitBounds(r.layer.getBounds()); }catch(e){}
  })();

  // Load points
  (async ()=>{
    const p = await loadGeoJSON(POINTS_GEOJSON,{
      pointToLayer: pointToMarker,
      onEachFeature: function(feature, layer){
        const props = feature.properties || {};
        layer.bindPopup(makePopupContent(props));

        // When user clicks the "Itinéraire" link in the popup
        layer.on('popupopen', function(e){
          const container = e.popup._contentNode || e.popup._content;
          // Attach click to route link
          container.querySelectorAll('[data-action="route"]').forEach(a=>{
            a.addEventListener('click', (ev)=>{
              ev.preventDefault();
              // Try to get user position then route
              if(navigator.geolocation){
                navigator.geolocation.getCurrentPosition(pos=>{
                  const from = L.latLng(pos.coords.latitude,pos.coords.longitude);
                  const to = layer.getLatLng ? layer.getLatLng() : layer.getBounds().getCenter();
                  routeBetween(from,to);
                }, err=>{
                  alert('Impossible de récupérer votre position: '+err.message);
                });
              }else{
                alert('Géolocalisation non supportée');
              }
            })
          })
        })
      }
    });
    if(p && p.layer){ pointsLayer.addLayer(p.layer); map.addLayer(pointsLayer); }

    // Créer un groupe combiné pour la recherche
    const combinedLayer = L.featureGroup([pointsLayer, regionsLayer]);

    // Ajouter un seul contrôle de recherche pour les deux couches
    const searchCombined = new L.Control.Search({
      layer: combinedLayer,
      propertyName: 'name',
      textPlaceholder: 'Recherche Localité ou Découpage Administrative',
      marker: false,
      moveToLocation: function(latlng, title, map){ map.setView(latlng, 12); }
    });
    map.addControl(searchCombined);

  })();

  

  </script>
</body>
</html>
